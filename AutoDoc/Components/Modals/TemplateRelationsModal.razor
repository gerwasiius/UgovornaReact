@using AutoDocFront.Components.Shared
@using AutoDocFront.Components.Shared.Inputs
@inherits ModalBase

<BaseModalLayout IsOpen="@IsOpen" Title="Pregled template-a" IsOpenChanged="@IsOpenChanged" ModalSize="modal-xl">
    <BodyContent>
        <div class="mb-3">
            <ReadOnlyInputText Label="Naziv"
                               Value="@FormData.Name" />
        </div>
        <div class="mb-3">
            <ReadOnlyInputText Label="Opis"
                               Value="@FormData.Description"
                               IsTextArea="true"
                               Rows="3" />
        </div>
        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0">Sekcije/članovi dokumenta</label>
                <button class="btn corporate-button-secondary btn-sm" @onclick="OpenSectionPicker">
                    <i class="fa fa-plus"></i> Dodaj sekcije
                </button>
            </div>
            <div class="bg-light border rounded p-2"
                 style="min-height:200px; max-height:350px; overflow-y:auto;">
                @if (FormData?.Relations == null || !FormData.Relations.Any())
                {
                    <div class="text-center text-secondary py-3">
                        Nema dodatih sekcija
                    </div>
                }
                else
                {
                    @foreach (var (sectionItem, idx) in FormData.Relations.Select((s, i) => (s, i)))
                    {
                        <div class="d-flex align-items-center justify-content-between bg-white border rounded mb-2 px-3 py-2">
                            <div class="d-flex align-items-center flex-grow-1">
                                <span class="badge bg-warning text-dark me-2">@(@idx + 1)</span>
                                <div>
                                    <span class="fw-medium">@sectionItem.SectionName</span>
                                </div>
                            </div>
                            <div class="d-flex gap-1">
                                <button class="btn corporate-button-secondary btn-sm" @onclick="() => MoveSection(idx, -1)" disabled="@(idx == 0)">
                                    <i class="fa fa-arrow-up"></i>
                                </button>
                                <button class="btn corporate-button-secondary btn-sm" @onclick="() => MoveSection(idx, 1)" disabled="@(idx == FormData.Relations.Count - 1)">
                                    <i class="fa fa-arrow-down"></i>
                                </button>
                                <button class="btn corporate-button-secondary btn-sm" title="Podesi uslove" @onclick="() => OpenConditionModal(idx)">
                                    <i class="fa fa-gear"></i>
                                </button>
                                <button class="btn corporate-button-secondary btn-sm" title="Pregled sekcije" @onclick="() => PreviewSection(idx)">
                                    <i class="fa fa-desktop"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" @onclick="() => RemoveSection(idx)">
                                    <i class="fa fa-x"></i>
                                </button>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </BodyContent>
    <FooterContent>
        <div class="modal-footer d-flex justify-content-between w-100">
            <div>
                <button class="btn corporate-button-secondary btn-sm" @onclick="ShowPreview" type="button">
                    <i class="fa fa-eye me-1"></i> Privremeni pregled
                </button>
            </div>
            <div>
                <button class="btn modal-corporate-button-primary" @onclick="Submit" disabled="@_isLoading">
                    Sačuvaj izmjene
                </button>
            </div>
        </div>
    </FooterContent>
</BaseModalLayout>

@if (_isSectionPickerOpen)
{
    <TemplateRelationPickerModal IsOpen="_isSectionPickerOpen"
                                 IsOpenChanged="@(v => _isSectionPickerOpen = v)"
                                 OnSectionsPicked="OnSectionsPicked" />
}

@if (_isPreviewModalOpen)
{
    <TemplatePreviewModal IsOpen="_isPreviewModalOpen"
                          IsOpenChanged="@(v => _isPreviewModalOpen = v)"
                          TemplateName="@_previewTemplateName"
                          HtmlContent="@_previewHtmlContent"
                          IsLoading="@_previewLoading"
                          ErrorMessage="@_previewError" />
}


@if (_isConditionModalOpen && _editingRelationIdx.HasValue)
{
    <TemplateRelationConditionModal IsOpen="_isConditionModalOpen"
                                    IsOpenChanged="@(v => _isConditionModalOpen = v)"
                                    Relation="FormData.Relations[_editingRelationIdx.Value]"
                                    OnSaved="CloseConditionModal" />
}